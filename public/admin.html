<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>后台管理 - 千早AI</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        th { background: #2575fc; color: white; }
        button { cursor: pointer; padding: 5px 10px; border: none; border-radius: 4px; }
        .del-btn { background: #ff4d4f; color: white; }
        .add-btn { background: #52c41a; color: white; padding: 10px 20px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>用户管理后台</h2>
        <div style="margin-bottom: 20px;">
            <input type="text" id="u" placeholder="用户名">
            <input type="password" id="p" placeholder="密码">
            <button class="add-btn" onclick="addUser()">添加新账户</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>ID</th><th>用户名</th><th>角色</th><th>创建时间</th><th>操作</th>
                </tr>
            </thead>
            <tbody id="userList"></tbody>
        </table>
    </div>
    <div class="card" style="margin-top: 30px;">
    <h2>聊天历史监控</h2>
    <table>
        <thead>
            <tr>
                <th>用户</th>
                <th>角色</th>
                <th>内容</th>
                <th>时间</th>
            </tr>
        </thead>
        <tbody id="msgList"></tbody>
    </table>
</div>
    <script>
        async function loadUsers() {
            const res = await fetch('/api/admin/users');
            const users = await res.json();
            document.getElementById('userList').innerHTML = users.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.username}</td>
                    <td>${u.role}</td>
                    <td>${new Date(u.created_at).toLocaleString()}</td>
                    <td><button class="del-btn" onclick="delUser(${u.id})">删除</button></td>
                </tr>
            `).join('');
        }

        async function addUser() {
            const username = document.getElementById('u').value;
            const password = document.getElementById('p').value;
            await fetch('/api/admin/create-user', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, password })
            });
            loadUsers();
        }

        async function delUser(id) {
            if(confirm('确定删除？')) {
                await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
                loadUsers();
            }
        }
        // 🟢 粘贴在这里：新增的获取消息函数
    async function loadMessages() {
        try {
            const res = await fetch('/api/admin/messages');
            const msgs = await res.json();
            document.getElementById('msgList').innerHTML = msgs.map(m => `
                <tr>
                    <td><b>${m.username}</b></td>
                    <td>${m.role === 'user' ? '👤 用户' : '🤖 AI'}</td>
                    <td>${m.content}</td>
                    <td>${new Date(m.created_at).toLocaleString()}</td>
                </tr>
            `).join('');
        } catch (err) {
            console.error("加载消息失败:", err);
        }
    }
        loadUsers();
        loadMessages();
    </script>
</body>
</html>